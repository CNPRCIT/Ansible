---
- hosts: all
  become: true
  gather_facts: False
  vars:

  tasks:
  # install mssql-server package
    - name: install mssql-server repo
      get_url:
        url: "{{ ubuntu_server_repo_url }}"
        dest: /etc/apt/sources.list.d/mssql-server.list

    - name: refresh apt-get cache for server repo
      apt:
        update_cache: yes

    - name: install mssql-server package
      package:
        name: mssql-server
      state: latest

# setup
    - name: mssql-server setup
      mssql_conf:
       setup_sa_password: "{{ sa_password }}"
       setup_pid: "{{ pid }}"
       login_name: 'sa'
       login_password: "{{ sa_password }}"
       
# TSQL endpoint

    - name: set TSQL endpoint port
      mssql_conf:
        name: network.tcpport
        value: "{{ tsql_endpoint_port }}"
        login_name: 'sa'
        login_password: "{{ sa_password }}"

    - name: open TSQL endpoint in firewall (Ubuntu)
      ufw:
        port: "{{ tsql_endpoint_port }}"
        proto: tcp
        rule: allow

# mssql-tools package

    - name: install mssql-tools repo (Ubuntu)
      get_url:
        url: "{{ ubuntu_tools_repo_url }}"
        dest: /etc/apt/sources.list.d/mssql-tools.list

    - name: refresh apt-get cache for server repo
      apt:
        update_cache: yes

    - name: install mssql-tools package
      apt:
        name: mssql-tools
        state: latest
      environment:
      ACCEPT_EULA: 'y'

# Start mssql-server service

    - name: start sqlservr
      service:
        name: mssql-server
        state: started