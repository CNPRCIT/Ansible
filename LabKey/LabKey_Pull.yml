---
- hosts: all
  become: true
  gather_facts: False
  vars:
    ## 
    ##Enter in the file name as it appears on the LabKey update page
    ##
    lbky_cnprc_file: LabKey18.2-SNAPSHOT-58506.512-cnprc-bin.tar.gz
    ##
    ##
    lbky_download_dir: /opt/lbky

#    lbky_aws_url: http://labkey.s3.amazonaws.com/downloads/cnprc/d/trunk
#    lbky_extract: "{{ lbky_cnprc_file | regex_replace('.tar.gz') }}"
#    lbky_home: /usr/local/labkey
#    tomcat_home: /opt/tomcat

  handlers:
    - name: Wait for system.
      local_action: wait_for host={{ ansible_ssh_host }} port=22 state=started delay=30 timeout=60
      become: False

  tasks:
#   Get variables from vault encrypted file.
    - name: Get variables
      include_vars: /home/cnprc/lbky.yml

    - name: Create LabKey home directory
      file:
        path: "{{ lbky_home }}"
        state: directory
        owner: tomcat
        group: root
        mode: 0755

    - name: Create download directory for LabKey pull
      file:
        path: "{{ lbky_download_dir }}"
        state: directory
        mode: 0755

    - name: Download and Unarchive LabKey
      unarchive:
        src: "{{ lbky_aws_url }}/{{ lbky_cnprc_file }}"
        dest: "{{ lbky_download_dir }}"
        remote_src: yes

    - name: Copy LabKey JAR files to tomcat-home/lib folder
      copy:
        src: "{{ lbky_download_dir }}/{{ lbky_extract }}/tomcat-lib/{{ item }}"
        dest: "{{ tomcat_home }}/lib/"
        owner: tomcat
        group: tomcat
        remote_src: yes
      with_items:
        - jtds.jar
        - mail.jar
        - mysql.jar
        - postgresql.jar
        - labkeyBootstrap.jar

## ansible copy does not do directories recursively, used synchronize (rsync)
    - name: Copy LabKey directories to Labkey home
      synchronize:
        src: "{{ lbky_download_dir }}/{{ lbky_extract }}/{{ item }}"
        dest: "{{ lbky_home }}"
      with_items:
        - labkeywebapp
        - modules
        - pipeline-lib
      delegate_to: "{{ inventory_hostname }}"

# synchronize does not allow setting of permissions.
    - name: Set directory permissions to Labkey home for tomcat
      file:
        path: "{{ lbky_home }}"
        owner: tomcat
        group: root
        recurse: yes
      

    - name: Replace LabKey Home string in LabKey Server config XML
      replace:
        path: "{{ lbky_download_dir }}/{{ lbky_extract }}/labkey.xml"
        regexp: '@@appDocBase@@'
        replace: "{{ lbky_home }}/labkeywebapp"

    - name: Copy LabKey XML to tomcat/Catalina/localhost
      copy:
        src: "{{ lbky_download_dir }}/{{ lbky_extract }}/{{ item }}"
        dest: "{{ tomcat_home }}/conf/Catalina/localhost"
        owner: tomcat
        group: tomcat
        remote_src: yes
      with_items:
        - labkey.xml

    - name: Reload and pick up config changes for Tomcat Service
      systemd:
        name: tomcat
        state: restarted
        daemon_reload: yes

    - name: Check if a reboot is required
      register: file
      stat: path=/var/run/reboot-required get_md5=no

    - name: Reboot the server
      shell: sleep 2 && /sbin/shutdown -r now
      async: 1
      poll: 0
      ignore_errors: true
      notify:
        - Wait for system.
      when: file.stat.exists == true